<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤–æŒ‚è®°å¿†å®éªŒç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #1890ff;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .btn-success {
            background: #52c41a;
            color: white;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: white;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
        }
        
        .memory-item {
            padding: 15px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .memory-item .trigger {
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 5px;
        }
        
        .memory-item .lesson {
            color: #666;
            margin-bottom: 5px;
        }
        
        .memory-item .meta {
            font-size: 12px;
            color: #999;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
        }
        
        .stat-card .label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .comparison-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  å¤–æŒ‚è®°å¿†å®éªŒç³»ç»Ÿ</h1>
            <p>æœ€å°å¯éªŒè¯æ¶æ„ - è®ºè¯å¤–æŒ‚è®°å¿†çš„5ä¸ªç‰¹æ€§</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('task')">æ‰§è¡Œä»»åŠ¡</button>
            <button class="tab" onclick="switchTab('memory')">è®°å¿†åº“</button>
            <button class="tab" onclick="switchTab('experiment')">å®éªŒå¯¹æ¯”</button>
        </div>
        
        <!-- æ‰§è¡Œä»»åŠ¡ -->
        <div id="task" class="tab-content active">
            <div class="card">
                <h2>æ‰§è¡Œä»»åŠ¡</h2>
                <div class="form-group">
                    <label>ä»»åŠ¡ç±»å‹</label>
                    <select id="taskType">
                        <option value="lottery">æŠ½å¥–åˆ¤æ–­</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¾“å…¥ï¼ˆJSONæ ¼å¼ï¼‰</label>
                    <textarea id="taskInput" placeholder='{"points": 50, "action": "lottery"}'></textarea>
                </div>
                <div class="form-group">
                    <label>å®éªŒç»„</label>
                    <select id="groupType">
                        <option value="A">Aç»„ï¼ˆæ— è®°å¿†ï¼‰</option>
                        <option value="B">Bç»„ï¼ˆæœ‰è®°å¿†ï¼Œæ— åæ€ï¼‰</option>
                        <option value="C" selected>Cç»„ï¼ˆæœ‰è®°å¿†+åæ€ï¼‰</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="executeTask()">æ‰§è¡Œä»»åŠ¡</button>
                <div id="taskResult" class="result" style="display:none;"></div>
            </div>
            
            <div class="card" id="feedbackCard" style="display:none;">
                <h2>åé¦ˆ</h2>
                <div class="form-group">
                    <label>åé¦ˆç±»å‹</label>
                    <select id="feedbackType">
                        <option value="correct">æ­£ç¡®</option>
                        <option value="incorrect">é”™è¯¯</option>
                        <option value="better">æ›´ä¼˜è§£</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åé¦ˆå†…å®¹</label>
                    <textarea id="feedbackContent" placeholder="è¯·è¾“å…¥åé¦ˆå†…å®¹..."></textarea>
                </div>
                <button class="btn btn-success" onclick="submitFeedback()">æäº¤åé¦ˆ</button>
                <button class="btn btn-primary" onclick="autoJudge()">è‡ªåŠ¨åˆ¤æ–­</button>
            </div>
        </div>
        
        <!-- è®°å¿†åº“ -->
        <div id="memory" class="tab-content">
            <div class="card">
                <h2>å¤–æŒ‚è®°å¿†åº“</h2>
                <button class="btn btn-primary" onclick="loadMemories()">åˆ·æ–°</button>
                <div id="memoriesList"></div>
            </div>
        </div>
        
        <!-- å®éªŒå¯¹æ¯” -->
        <div id="experiment" class="tab-content">
            <div class="card">
                <h2>å®éªŒç»Ÿè®¡</h2>
                <button class="btn btn-primary" onclick="loadStats()">åˆ·æ–°ç»Ÿè®¡</button>
                <div id="statsContent"></div>
            </div>
            
            <div class="card">
                <h2>ç»„é—´å¯¹æ¯”</h2>
                <button class="btn btn-primary" onclick="compareGroups()">å¯¹æ¯”A/B/Cç»„</button>
                <div id="comparisonContent"></div>
            </div>
            
            <div class="card">
                <h2>é”™è¯¯è¶‹åŠ¿</h2>
                <button class="btn btn-primary" onclick="loadTrend()">æŸ¥çœ‹è¶‹åŠ¿</button>
                <div id="trendContent"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8080/api';
        let currentTaskId = null;
        
        // æµ‹è¯•APIè¿æ¥
        async function testConnection() {
            try {
                const res = await fetch(`${API_BASE}/memories`);
                if (res.ok) {
                    console.log('APIè¿æ¥æ­£å¸¸');
                } else {
                    console.error('APIè¿æ¥å¤±è´¥:', res.status);
                }
            } catch (error) {
                console.error('æ— æ³•è¿æ¥åˆ°API:', error);
                alert('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨åœ¨ http://localhost:8080');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æµ‹è¯•è¿æ¥
        window.addEventListener('load', () => {
            testConnection();
        });
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        async function executeTask() {
            const taskType = document.getElementById('taskType').value;
            const input = document.getElementById('taskInput').value;
            const groupType = document.getElementById('groupType').value;
            const useMemory = groupType !== 'A';
            
            if (!input.trim()) {
                alert('è¯·è¾“å…¥ä»»åŠ¡è¾“å…¥');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/tasks/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        task_type: taskType,
                        input: input,
                        group_type: groupType,
                        use_memory: useMemory
                    })
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({error: 'è¯·æ±‚å¤±è´¥'}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data || !data.task) {
                    throw new Error('å“åº”æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
                }
                
                currentTaskId = data.task.id;
                
                document.getElementById('taskResult').style.display = 'block';
                document.getElementById('taskResult').textContent = 
                    `ä»»åŠ¡ID: ${data.task.id}\n` +
                    `è¾“å‡º: ${data.task.output || 'æ— '}\n` +
                    `Tokenæ¶ˆè€—: ${data.task.token_count || 0}\n` +
                    `ä½¿ç”¨çš„è®°å¿†: ${data.task.memory_ids || 'æ— '}`;
                
                document.getElementById('feedbackCard').style.display = 'block';
            } catch (error) {
                alert('æ‰§è¡Œå¤±è´¥: ' + error.message);
                console.error('æ‰§è¡Œä»»åŠ¡é”™è¯¯:', error);
            }
        }
        
        async function submitFeedback() {
            if (!currentTaskId) {
                alert('è¯·å…ˆæ‰§è¡Œä»»åŠ¡');
                return;
            }
            
            const feedbackType = document.getElementById('feedbackType').value;
            const content = document.getElementById('feedbackContent').value;
            
            try {
                const res = await fetch(`${API_BASE}/tasks/feedback`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        task_id: currentTaskId,
                        feedback_type: feedbackType,
                        content: content
                    })
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({error: 'è¯·æ±‚å¤±è´¥'}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data || !data.feedback) {
                    throw new Error('å“åº”æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
                }
                
                if (feedbackType === 'incorrect' && data.feedback.id) {
                    // è‡ªåŠ¨è§¦å‘åæ€
                    await reflectAndSave(currentTaskId, data.feedback.id);
                }
                
                alert('åé¦ˆæäº¤æˆåŠŸ');
                loadMemories();
            } catch (error) {
                alert('æäº¤å¤±è´¥: ' + error.message);
                console.error('æäº¤åé¦ˆé”™è¯¯:', error);
            }
        }
        
        async function autoJudge() {
            if (!currentTaskId) {
                alert('è¯·å…ˆæ‰§è¡Œä»»åŠ¡');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/tasks/judge`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        task_id: currentTaskId
                    })
                });
                
                alert('è‡ªåŠ¨åˆ¤æ–­å®Œæˆ');
                loadMemories();
            } catch (error) {
                alert('åˆ¤æ–­å¤±è´¥: ' + error.message);
            }
        }
        
        async function reflectAndSave(taskId, feedbackId) {
            try {
                await fetch(`${API_BASE}/tasks/reflect`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        task_id: taskId,
                        feedback_id: feedbackId
                    })
                });
            } catch (error) {
                console.error('åæ€å¤±è´¥:', error);
            }
        }
        
        async function loadMemories() {
            try {
                const res = await fetch(`${API_BASE}/memories`);
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({error: 'è¯·æ±‚å¤±è´¥'}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data || !data.memories) {
                    throw new Error('å“åº”æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
                }
                
                const list = document.getElementById('memoriesList');
                list.innerHTML = '';
                
                if (data.memories.length === 0) {
                    list.innerHTML = '<p style="color: #999; padding: 20px; text-align: center;">æš‚æ— è®°å¿†</p>';
                    return;
                }
                
                data.memories.forEach(m => {
                    const item = document.createElement('div');
                    item.className = 'memory-item';
                    item.innerHTML = `
                        <div class="trigger">è§¦å‘: ${m.trigger || 'æ— '}</div>
                        <div class="lesson">ç»éªŒ: ${m.lesson || 'æ— '}</div>
                        <div class="meta">
                            ç½®ä¿¡åº¦: ${m.confidence || 0} | 
                            ç‰ˆæœ¬: ${m.version || 1} | 
                            ä½¿ç”¨æ¬¡æ•°: ${m.use_count || 0} |
                            é€‚ç”¨èŒƒå›´: ${m.apply_to || 'é€šç”¨'}
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                alert('åŠ è½½å¤±è´¥: ' + error.message);
                console.error('åŠ è½½è®°å¿†é”™è¯¯:', error);
            }
        }
        
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/experiments/stats`);
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({error: 'è¯·æ±‚å¤±è´¥'}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data || !data.stats) {
                    throw new Error('å“åº”æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
                }
                
                const content = document.getElementById('statsContent');
                const stats = data.stats;
                content.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="value">${stats.total || 0}</div>
                            <div class="label">æ€»ä»»åŠ¡æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${stats.correct || 0}</div>
                            <div class="label">æ­£ç¡®</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${stats.incorrect || 0}</div>
                            <div class="label">é”™è¯¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${((stats.error_rate || 0) * 100).toFixed(1)}%</div>
                            <div class="label">é”™è¯¯ç‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${stats.avg_tokens || 0}</div>
                            <div class="label">å¹³å‡Token</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                alert('åŠ è½½å¤±è´¥: ' + error.message);
                console.error('åŠ è½½ç»Ÿè®¡é”™è¯¯:', error);
            }
        }
        
        async function compareGroups() {
            try {
                const res = await fetch(`${API_BASE}/experiments/compare`);
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({error: 'è¯·æ±‚å¤±è´¥'}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data || !data.comparison) {
                    throw new Error('å“åº”æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
                }
                
                const content = document.getElementById('comparisonContent');
                let html = '<table class="comparison-table"><tr><th>æŒ‡æ ‡</th><th>Aç»„</th><th>Bç»„</th><th>Cç»„</th></tr>';
                
                const groups = ['A', 'B', 'C'];
                const metrics = ['total', 'correct', 'incorrect', 'error_rate', 'avg_tokens'];
                const labels = {'total': 'æ€»ä»»åŠ¡', 'correct': 'æ­£ç¡®', 'incorrect': 'é”™è¯¯', 'error_rate': 'é”™è¯¯ç‡', 'avg_tokens': 'å¹³å‡Token'};
                
                metrics.forEach(metric => {
                    html += `<tr><td>${labels[metric]}</td>`;
                    groups.forEach(group => {
                        const value = data.comparison[group]?.[metric] || 0;
                        const display = metric === 'error_rate' ? ((value || 0) * 100).toFixed(1) + '%' : value;
                        html += `<td>${display}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table>';
                content.innerHTML = html;
            } catch (error) {
                alert('å¯¹æ¯”å¤±è´¥: ' + error.message);
                console.error('å¯¹æ¯”ç»„é”™è¯¯:', error);
            }
        }
        
        async function loadTrend() {
            try {
                const res = await fetch(`${API_BASE}/experiments/trend`);
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({error: 'è¯·æ±‚å¤±è´¥'}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data || !data.trend) {
                    throw new Error('å“åº”æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
                }
                
                const content = document.getElementById('trendContent');
                let html = '<table class="comparison-table"><tr><th>æ—¥æœŸ</th><th>æ€»æ•°</th><th>æ­£ç¡®</th><th>é”™è¯¯</th></tr>';
                
                if (data.trend.length === 0) {
                    html += '<tr><td colspan="4" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
                } else {
                    data.trend.forEach(item => {
                        html += `<tr>
                            <td>${item.date || 'æœªçŸ¥'}</td>
                            <td>${item.total || 0}</td>
                            <td>${item.correct || 0}</td>
                            <td>${item.incorrect || 0}</td>
                        </tr>`;
                    });
                }
                
                html += '</table>';
                content.innerHTML = html;
            } catch (error) {
                alert('åŠ è½½å¤±è´¥: ' + error.message);
                console.error('åŠ è½½è¶‹åŠ¿é”™è¯¯:', error);
            }
        }
    </script>
</body>
</html>

